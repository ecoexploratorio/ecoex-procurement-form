<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>EcoExploratorio - Purchase Request System v1.2</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700;800&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --eco-purple: #6B46C1;
      --eco-teal: #0E7490;
      --eco-pink: #DB2777;
      --eco-yellow: #F59E0B;
      --eco-green: #059669;
      --eco-blue: #2563EB;
      
      --navy: #0A1628;
      --slate: #F1F5F9;
      --border: #E2E8F0;
      --text: #1E293B;
      --muted: #64748B;
      --white: #FFFFFF;
      --success: #10B981;
      --warning: #F59E0B;
      --error: #EF4444;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Outfit', sans-serif;
      background: linear-gradient(135deg, var(--slate) 0%, #E0E7FF 100%);
      min-height: 100vh;
      padding: 24px 16px;
      color: var(--text);
    }

    .container {
      max-width: 900px;
      margin: 0 auto;
    }

    /* Header */
    .header {
      text-align: center;
      margin-bottom: 40px;
      animation: fadeSlideDown 0.6s ease;
    }

    .logo-badge {
      display: inline-flex;
      align-items: center;
      gap: 12px;
      background: var(--white);
      padding: 12px 24px;
      border-radius: 100px;
      box-shadow: 0 4px 24px rgba(10, 22, 40, 0.08);
      margin-bottom: 16px;
    }

    .logo-dots {
      display: flex;
      gap: 4px;
    }

    .logo-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      animation: pulse 2s infinite;
    }

    .logo-dot:nth-child(1) { background: var(--eco-purple); animation-delay: 0s; }
    .logo-dot:nth-child(2) { background: var(--eco-teal); animation-delay: 0.2s; }
    .logo-dot:nth-child(3) { background: var(--eco-pink); animation-delay: 0.4s; }
    .logo-dot:nth-child(4) { background: var(--eco-yellow); animation-delay: 0.6s; }

    .org-name {
      font-family: 'Space Mono', monospace;
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.1em;
      color: var(--navy);
      text-transform: uppercase;
    }

    h1 {
      font-size: 36px;
      font-weight: 800;
      color: var(--navy);
      margin-bottom: 8px;
      line-height: 1.2;
    }

    .subtitle {
      font-size: 16px;
      color: var(--muted);
      font-weight: 400;
    }

    .version-badge {
      display: inline-block;
      background: linear-gradient(135deg, var(--eco-purple), var(--eco-teal));
      color: white;
      padding: 4px 12px;
      border-radius: 100px;
      font-size: 11px;
      font-weight: 700;
      margin-left: 8px;
      letter-spacing: 0.05em;
    }

    /* Progress Steps */
    .progress-container {
      background: var(--white);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 24px;
      box-shadow: 0 2px 12px rgba(10, 22, 40, 0.06);
    }

    .progress-steps {
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: relative;
    }

    .progress-line {
      position: absolute;
      top: 20px;
      left: 40px;
      right: 40px;
      height: 2px;
      background: var(--border);
      z-index: 1;
    }

    .progress-line-fill {
      height: 100%;
      background: linear-gradient(90deg, var(--eco-purple), var(--eco-teal));
      transition: width 0.4s ease;
      border-radius: 2px;
    }

    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 8px;
      z-index: 2;
      position: relative;
    }

    .step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--white);
      border: 3px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      color: var(--muted);
      transition: all 0.3s ease;
    }

    .step.active .step-circle {
      background: linear-gradient(135deg, var(--eco-purple), var(--eco-teal));
      border-color: var(--eco-purple);
      color: var(--white);
      box-shadow: 0 4px 16px rgba(107, 70, 193, 0.3);
    }

    .step.completed .step-circle {
      background: var(--success);
      border-color: var(--success);
      color: var(--white);
    }

    .step-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--muted);
      text-align: center;
    }

    .step.active .step-label {
      color: var(--eco-purple);
      font-weight: 700;
    }

    /* Form Card */
    .form-card {
      background: var(--white);
      border-radius: 20px;
      padding: 40px;
      box-shadow: 0 8px 32px rgba(10, 22, 40, 0.08);
      margin-bottom: 24px;
      animation: fadeSlideUp 0.5s ease;
    }

    .form-section {
      display: none;
    }

    .form-section.active {
      display: block;
      animation: fadeIn 0.4s ease;
    }

    .section-title {
      font-size: 24px;
      font-weight: 700;
      color: var(--navy);
      margin-bottom: 8px;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .section-icon {
      width: 32px;
      height: 32px;
      border-radius: 8px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .section-description {
      font-size: 14px;
      color: var(--muted);
      margin-bottom: 32px;
      line-height: 1.6;
    }

    /* Form Fields */
    .form-grid {
      display: grid;
      grid-template-columns: 1fr;
      gap: 24px;
    }

    .form-grid.two-col {
      grid-template-columns: 1fr 1fr;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-group.full-width {
      grid-column: 1 / -1;
    }

    label {
      font-size: 14px;
      font-weight: 600;
      color: var(--navy);
      display: flex;
      align-items: center;
      gap: 4px;
    }

    .required {
      color: var(--error);
    }

    input, select, textarea {
      padding: 12px 16px;
      border: 2px solid var(--border);
      border-radius: 12px;
      font-family: 'Outfit', sans-serif;
      font-size: 15px;
      color: var(--text);
      transition: all 0.2s ease;
      background: var(--white);
    }

    input:focus, select:focus, textarea:focus {
      outline: none;
      border-color: var(--eco-purple);
      box-shadow: 0 0 0 4px rgba(107, 70, 193, 0.1);
    }

    textarea {
      resize: vertical;
      min-height: 100px;
    }

    .input-hint {
      font-size: 12px;
      color: var(--muted);
      font-weight: 400;
    }

    /* LINE ITEMS TABLE - NEW IN v1.2 */
    .line-items-container {
      border: 2px solid var(--border);
      border-radius: 12px;
      overflow: hidden;
      margin: 24px 0;
    }

    .line-items-header {
      background: linear-gradient(135deg, var(--eco-purple), var(--eco-teal));
      color: white;
      padding: 16px;
      font-weight: 700;
      font-size: 15px;
    }

    .line-items-table {
      width: 100%;
    }

    .line-item-row {
      display: grid;
      grid-template-columns: 2fr 80px 120px 120px 40px;
      gap: 12px;
      padding: 12px 16px;
      border-bottom: 1px solid var(--border);
      align-items: center;
    }

    .line-item-row:last-child {
      border-bottom: none;
    }

    .line-item-row input {
      margin: 0;
    }

    .line-item-row .item-desc {
      grid-column: 1;
    }

    .line-item-row .item-qty {
      grid-column: 2;
      text-align: center;
    }

    .line-item-row .item-price {
      grid-column: 3;
    }

    .line-item-row .item-subtotal {
      grid-column: 4;
      font-weight: 700;
      color: var(--navy);
      text-align: right;
      padding-right: 8px;
    }

    .line-item-row .item-remove {
      grid-column: 5;
      background: none;
      border: none;
      color: var(--error);
      cursor: pointer;
      font-size: 20px;
      padding: 0;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      transition: all 0.2s;
    }

    .line-item-row .item-remove:hover {
      background: rgba(239, 68, 68, 0.1);
    }

    .add-item-btn {
      background: var(--slate);
      border: 2px dashed var(--border);
      color: var(--eco-purple);
      padding: 12px;
      width: 100%;
      border-radius: 0;
      cursor: pointer;
      font-weight: 600;
      font-size: 14px;
      transition: all 0.2s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
    }

    .add-item-btn:hover {
      background: rgba(107, 70, 193, 0.05);
      border-color: var(--eco-purple);
    }

    /* PRICE SUMMARY - NEW IN v1.2 */
    .price-summary {
      background: linear-gradient(135deg, rgba(107, 70, 193, 0.05), rgba(14, 116, 144, 0.05));
      border: 2px solid var(--eco-purple);
      border-radius: 12px;
      padding: 24px;
      margin-top: 24px;
    }

    .price-summary-title {
      font-size: 16px;
      font-weight: 700;
      color: var(--navy);
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .price-row {
      display: flex;
      justify-content: space-between;
      padding: 8px 0;
      font-size: 15px;
    }

    .price-row.subtotal {
      border-top: 1px solid var(--border);
      padding-top: 12px;
      margin-top: 8px;
    }

    .price-row.total {
      border-top: 2px solid var(--eco-purple);
      padding-top: 12px;
      margin-top: 8px;
      font-size: 20px;
      font-weight: 800;
      color: var(--eco-purple);
    }

    .tax-options {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin: 12px 0;
    }

    .tax-option {
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px;
      cursor: pointer;
      border-radius: 8px;
      transition: background 0.2s;
    }

    .tax-option:hover {
      background: rgba(107, 70, 193, 0.05);
    }

    .tax-option input[type="radio"] {
      width: 18px;
      height: 18px;
      margin: 0;
    }

    .tax-option label {
      margin: 0;
      cursor: pointer;
      font-weight: 500;
    }

    /* QUOTES SECTION - NEW IN v1.2 */
    .quotes-container {
      display: grid;
      gap: 16px;
      margin-top: 24px;
    }

    .quote-card {
      border: 2px solid var(--border);
      border-radius: 12px;
      padding: 20px;
      transition: all 0.2s;
    }

    .quote-card.selected {
      border-color: var(--eco-purple);
      background: rgba(107, 70, 193, 0.02);
    }

    .quote-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }

    .quote-number {
      font-weight: 700;
      color: var(--navy);
      font-size: 16px;
    }

    .quote-badge {
      background: var(--eco-purple);
      color: white;
      padding: 4px 12px;
      border-radius: 100px;
      font-size: 11px;
      font-weight: 700;
    }

    .quote-fields {
      display: grid;
      gap: 16px;
    }

    .quote-comparison {
      margin-top: 24px;
      padding: 16px;
      background: var(--slate);
      border-radius: 12px;
    }

    .comparison-table {
      width: 100%;
      border-collapse: collapse;
    }

    .comparison-table th {
      text-align: left;
      padding: 8px;
      color: var(--muted);
      font-size: 13px;
      font-weight: 600;
    }

    .comparison-table td {
      padding: 8px;
      font-size: 14px;
    }

    .comparison-table .best-price {
      color: var(--success);
      font-weight: 700;
    }

    /* Info Box */
    .info-box {
      background: linear-gradient(135deg, rgba(107, 70, 193, 0.05), rgba(14, 116, 144, 0.05));
      border-left: 4px solid var(--eco-purple);
      padding: 16px;
      border-radius: 12px;
      margin-top: 16px;
      display: flex;
      gap: 12px;
    }

    .info-box-icon {
      font-size: 20px;
      flex-shrink: 0;
    }

    .info-box-content {
      font-size: 13px;
      line-height: 1.6;
      color: var(--text);
    }

    .info-box strong {
      color: var(--eco-purple);
      font-weight: 700;
    }

    /* Alert Boxes */
    .alert {
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 20px;
      display: flex;
      align-items: flex-start;
      gap: 12px;
      font-size: 14px;
      line-height: 1.5;
      animation: slideDown 0.3s ease;
    }

    .alert-warning {
      background: rgba(245, 158, 11, 0.1);
      border: 2px solid var(--warning);
      color: #92400E;
    }

    .alert-success {
      background: rgba(16, 185, 129, 0.1);
      border: 2px solid var(--success);
      color: #065F46;
    }

    .alert-info {
      background: rgba(37, 99, 235, 0.1);
      border: 2px solid var(--eco-blue);
      color: #1E40AF;
    }

    /* File Upload */
    .file-upload {
      border: 2px dashed var(--border);
      border-radius: 12px;
      padding: 24px;
      text-align: center;
      cursor: pointer;
      transition: all 0.2s ease;
    }

    .file-upload:hover {
      border-color: var(--eco-purple);
      background: rgba(107, 70, 193, 0.02);
    }

    .file-upload-icon {
      font-size: 32px;
      margin-bottom: 8px;
    }

    .file-upload input[type="file"] {
      display: none;
    }

    .file-upload-text {
      font-size: 14px;
      color: var(--text);
      font-weight: 600;
    }

    .file-upload-hint {
      font-size: 12px;
      color: var(--muted);
      margin-top: 4px;
    }

    .file-list {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .file-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 8px 12px;
      background: var(--slate);
      border-radius: 8px;
      font-size: 13px;
    }

    .file-item-name {
      font-weight: 600;
      color: var(--navy);
    }

    .file-item-remove {
      color: var(--error);
      cursor: pointer;
      font-weight: 600;
    }

    /* Navigation Buttons */
    .form-nav {
      display: flex;
      justify-content: space-between;
      gap: 16px;
      margin-top: 32px;
    }

    .btn {
      padding: 14px 28px;
      border-radius: 12px;
      font-family: 'Outfit', sans-serif;
      font-size: 15px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }

    .btn-primary {
      background: linear-gradient(135deg, var(--eco-purple), var(--eco-teal));
      color: var(--white);
      box-shadow: 0 4px 16px rgba(107, 70, 193, 0.3);
    }

    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 24px rgba(107, 70, 193, 0.4);
    }

    .btn-secondary {
      background: var(--slate);
      color: var(--navy);
      border: 2px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--border);
    }

    .btn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
      transform: none !important;
    }

    /* Success Screen */
    .success-screen {
      text-align: center;
      padding: 60px 20px;
    }

    .success-icon {
      font-size: 80px;
      margin-bottom: 24px;
      animation: scaleIn 0.5s ease;
    }

    .success-title {
      font-size: 28px;
      font-weight: 800;
      color: var(--navy);
      margin-bottom: 12px;
    }

    .success-message {
      font-size: 16px;
      color: var(--muted);
      margin-bottom: 32px;
      line-height: 1.6;
    }

    .pr-number {
      display: inline-block;
      background: linear-gradient(135deg, var(--eco-purple), var(--eco-teal));
      color: var(--white);
      padding: 12px 24px;
      border-radius: 100px;
      font-family: 'Space Mono', monospace;
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 32px;
      box-shadow: 0 4px 20px rgba(107, 70, 193, 0.3);
    }

    /* Animations */
    @keyframes fadeSlideDown {
      from {
        opacity: 0;
        transform: translateY(-20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeSlideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }

    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }

    @keyframes pulse {
      0%, 100% { transform: scale(1); opacity: 1; }
      50% { transform: scale(1.2); opacity: 0.7; }
    }

    @keyframes scaleIn {
      from {
        transform: scale(0.5);
        opacity: 0;
      }
      to {
        transform: scale(1);
        opacity: 1;
      }
    }

    @keyframes slideDown {
      from {
        transform: translateY(-10px);
        opacity: 0;
      }
      to {
        transform: translateY(0);
        opacity: 1;
      }
    }

    /* Responsive */
    @media (max-width: 768px) {
      .form-grid.two-col {
        grid-template-columns: 1fr;
      }

      .form-card {
        padding: 24px;
      }

      h1 {
        font-size: 28px;
      }

      .progress-steps {
        gap: 8px;
      }

      .step-label {
        font-size: 10px;
      }

      .step-circle {
        width: 32px;
        height: 32px;
        font-size: 12px;
      }

      .line-item-row {
        grid-template-columns: 1fr;
        gap: 8px;
      }

      .line-item-row .item-desc,
      .line-item-row .item-qty,
      .line-item-row .item-price,
      .line-item-row .item-subtotal {
        grid-column: 1;
      }
    }

    /* Loading Spinner */
    .spinner {
      border: 3px solid rgba(107, 70, 193, 0.1);
      border-top: 3px solid var(--eco-purple);
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    .loading-text {
      text-align: center;
      color: var(--muted);
      font-size: 14px;
      margin-top: 16px;
    }
  </style>
</head>
<body>
  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="logo-badge">
        <div class="logo-dots">
          <div class="logo-dot"></div>
          <div class="logo-dot"></div>
          <div class="logo-dot"></div>
          <div class="logo-dot"></div>
        </div>
        <span class="org-name">EcoExploratorio</span>
      </div>
      <h1>
        Purchase Request
        <span class="version-badge">v1.3 LITE</span>
      </h1>
      <p class="subtitle">Sistema de solicitud de compras y adquisiciones</p>
    </div>

    <!-- Progress Steps -->
    <div class="progress-container">
      <div class="progress-steps">
        <div class="progress-line">
          <div class="progress-line-fill" id="progressFill" style="width: 0%"></div>
        </div>
        <div class="step active" id="step1">
          <div class="step-circle">1</div>
          <div class="step-label">Informaci√≥n B√°sica</div>
        </div>
        <div class="step" id="step2">
          <div class="step-circle">2</div>
          <div class="step-label">Items & Precios</div>
        </div>
        <div class="step" id="step3">
          <div class="step-circle">3</div>
          <div class="step-label">Cotizaciones</div>
        </div>
        <div class="step" id="step4">
          <div class="step-circle">4</div>
          <div class="step-label">Revisi√≥n</div>
        </div>
      </div>
    </div>

    <!-- Form -->
    <form id="purchaseRequestForm">
      <!-- Step 1: Basic Information -->
      <div class="form-section active" id="section1">
        <div class="form-card">
          <div class="section-title">
            <div class="section-icon" style="background: linear-gradient(135deg, var(--eco-purple), var(--eco-teal)); color: white;">üë§</div>
            Informaci√≥n B√°sica
          </div>
          <div class="section-description">
            Ingresa tu informaci√≥n y detalles del departamento.
          </div>

          <div class="form-grid two-col">
            <div class="form-group">
              <label>Nombre Completo <span class="required">*</span></label>
              <input type="text" id="requestorName" required placeholder="Juan P√©rez">
            </div>

            <div class="form-group">
              <label>Email <span class="required">*</span></label>
              <input type="email" id="requestorEmail" required placeholder="juan.perez@ecoexploratorio.org">
            </div>

            <div class="form-group">
              <label>Departamento <span class="required">*</span></label>
              <select id="department" required>
                <option value="">Selecciona tu departamento</option>
                <option value="Administraci√≥n">Administraci√≥n</option>
                <option value="Educaci√≥n">Educaci√≥n</option>
                <option value="Exhibiciones">Exhibiciones</option>
                <option value="Finanzas">Finanzas</option>
                <option value="Operaciones">Operaciones</option>
                <option value="Programas">Programas</option>
                <option value="Desarrollo">Desarrollo</option>
              </select>
            </div>

            <div class="form-group">
              <label>Puesto</label>
              <input type="text" id="position" placeholder="Coordinador de Programas">
            </div>

            <div class="form-group full-width">
              <label>Supervisor <span class="required">*</span></label>
              <input type="text" id="supervisorName" required placeholder="Nombre de tu supervisor directo">
              <span class="input-hint">Tu supervisor recibir√° un email para aprobar esta solicitud</span>
            </div>

            <div class="form-group full-width">
              <label>Fuente de Fondos <span class="required">*</span></label>
              <select id="fundingSource" required>
                <option value="">Selecciona fuente</option>
                <option value="Federal">Federal</option>
                <option value="Non-Federal">Non-Federal</option>
              </select>
            </div>

            <div class="form-group full-width" id="grantNameGroup" style="display: none;">
              <label>Grant / Proyecto <span class="required">*</span></label>
              <select id="grantName" required disabled>
                <option value="">Selecciona el grant</option>
              </select>
            </div>

            <div class="form-group full-width" id="budgetCategoryGroup" style="display: none;">
              <label>Categor√≠a de Presupuesto <span class="required">*</span></label>
              <select id="budgetCategory" required disabled>
                <option value="">Selecciona la categor√≠a</option>
                <option value="Personnel">Personnel (Salarios y beneficios)</option>
                <option value="Equipment">Equipment (Equipos y maquinaria)</option>
                <option value="Supplies">Supplies (Materiales y suministros)</option>
                <option value="Travel">Travel (Viajes y dietas)</option>
                <option value="Contractual">Contractual (Servicios contratados)</option>
                <option value="Other">Other (Otros gastos directos)</option>
                <option value="Indirect">Indirect (Costos indirectos)</option>
              </select>
              <span class="input-hint">Esta categor√≠a debe coincidir con tu presupuesto aprobado del grant</span>
            </div>

            <div id="budgetCheckResult" style="display: none; margin-top: 16px;">
              <!-- Budget availability shown here -->
            </div>
          </div>
        </div>
      </div>

      <!-- Step 2: Items & Pricing (NEW IN v1.2) -->
      <div class="form-section" id="section2">
        <div class="form-card">
          <div class="section-title">
            <div class="section-icon" style="background: linear-gradient(135deg, var(--eco-teal), var(--eco-green)); color: white;">üõí</div>
            Items & Precios
          </div>
          <div class="section-description">
            Especifica los productos o servicios que necesitas comprar.
          </div>

          <div class="form-group">
            <label>Vendor Principal <span class="required">*</span></label>
            <input type="text" id="vendorName" required placeholder="Office Depot, Amazon, etc.">
          </div>

          <div class="form-group">
            <label>Descripci√≥n General de la Compra <span class="required">*</span></label>
            <textarea id="generalDescription" required placeholder="Ej: Compra de equipos de oficina para departamento de Educaci√≥n..."></textarea>
            <span class="input-hint">Describe el prop√≥sito general de esta compra</span>
          </div>

          <!-- LINE ITEMS TABLE -->
          <div class="line-items-container">
            <div class="line-items-header">
              üìã Items a Comprar
            </div>
            <div class="line-items-table" id="lineItemsTable">
              <!-- Headers (visual only) -->
              <div class="line-item-row" style="background: var(--slate); font-weight: 600; font-size: 13px;">
                <div class="item-desc">Descripci√≥n</div>
                <div class="item-qty" style="text-align: center;">Cant.</div>
                <div class="item-price">Precio Unit.</div>
                <div class="item-subtotal">Subtotal</div>
                <div></div>
              </div>
              
              <!-- Line Item 1 (default) -->
              <div class="line-item-row" data-item-id="1">
                <input type="text" class="item-desc" placeholder="Ej: Laptop Dell XPS 15" required>
                <input type="number" class="item-qty" min="1" value="1" required>
                <input type="number" class="item-price" step="0.01" min="0" placeholder="0.00" required>
                <div class="item-subtotal">$0.00</div>
                <button type="button" class="item-remove" onclick="removeLineItem(1)" title="Eliminar">√ó</button>
              </div>
            </div>
            <button type="button" class="add-item-btn" onclick="addLineItem()">
              <span>+</span> Agregar Otro Item
            </button>
          </div>

          <!-- PRICE SUMMARY -->
          <div class="price-summary">
            <div class="price-summary-title">
              üí∞ Resumen de Precios
            </div>

            <div class="price-row subtotal">
              <span>Subtotal:</span>
              <span id="displaySubtotal" style="font-weight: 700;">$0.00</span>
            </div>

            <div class="tax-options">
              <div class="tax-option">
                <input type="radio" id="taxIVU" name="taxType" value="ivu" checked>
                <label for="taxIVU">Incluir IVU (11.5%)</label>
              </div>
              <div class="tax-option">
                <input type="radio" id="taxExempt" name="taxType" value="exempt">
                <label for="taxExempt">Tax Exempt (adjuntar certificado de exenci√≥n)</label>
              </div>
              <div class="tax-option">
                <input type="radio" id="taxNone" name="taxType" value="none">
                <label for="taxNone">No aplica IVU (B2B o servicio exento)</label>
              </div>
            </div>

            <div class="price-row" id="taxRow" style="color: var(--muted);">
              <span>IVU (11.5%):</span>
              <span id="displayTax">$0.00</span>
            </div>

            <div class="price-row total">
              <span>TOTAL:</span>
              <span id="displayTotal">$0.00</span>
            </div>
          </div>

          <div class="info-box">
            <span class="info-box-icon">‚ÑπÔ∏è</span>
            <div class="info-box-content">
              <strong>Nota importante:</strong> El total que ves aqu√≠ es el monto que se descontar√° del presupuesto. 
              Aseg√∫rate de que incluya todos los costos (IVU, shipping, fees, etc.) para evitar problemas de budget.
            </div>
          </div>

          <div id="procurementInfo" style="display: none;">
            <!-- Dynamically populated -->
          </div>
        </div>
      </div>

      <!-- Step 3: Quotes (NEW IN v1.2) -->
      <div class="form-section" id="section3">
        <div class="form-card">
          <div class="section-title">
            <div class="section-icon" style="background: linear-gradient(135deg, var(--eco-pink), var(--eco-yellow)); color: white;">üìé</div>
            Cotizaciones
          </div>
          <div class="section-description">
            Sube las cotizaciones requeridas seg√∫n el monto de la compra.
          </div>

          <div id="quotesSection">
            <!-- Dynamically populated based on procurement method -->
          </div>

          <div class="form-group" style="margin-top: 24px;">
            <label>Tipo de Compra</label>
            <select id="purchaseType">
              <option value="standard">Compra Est√°ndar</option>
              <option value="sole-source">Sole Source (√∫nica fuente)</option>
              <option value="emergency">Emergencia (‚â§$500 non-federal)</option>
            </select>
          </div>

          <div id="soleSourceSection" style="display: none; margin-top: 24px;">
            <div class="alert alert-warning">
              <span>‚ö†Ô∏è</span>
              <div>
                <strong>Sole Source requiere justificaci√≥n especial.</strong><br>
                Debes explicar por qu√© este vendor es la √∫nica opci√≥n disponible.
              </div>
            </div>
            <div class="form-group">
              <label>Justificaci√≥n de Sole Source <span class="required">*</span></label>
              <textarea id="soleSourceJustification" placeholder="Explica por qu√© este es el √∫nico vendor disponible..."></textarea>
            </div>
          </div>

          <div id="emergencySection" style="display: none; margin-top: 24px;">
            <div class="alert alert-warning">
              <span>‚ö†Ô∏è</span>
              <div>
                <strong>Compras de emergencia limitadas a $500 non-federal.</strong><br>
                Debes someter este PR dentro de 3 d√≠as h√°biles de la compra.
              </div>
            </div>
            <div class="form-group">
              <label>Justificaci√≥n de Emergencia <span class="required">*</span></label>
              <textarea id="emergencyJustification" placeholder="Explica la emergencia que requiri√≥ esta compra..."></textarea>
            </div>
          </div>
        </div>
      </div>

      <!-- Step 4: Review -->
      <div class="form-section" id="section4">
        <div class="form-card">
          <div class="section-title">
            <div class="section-icon" style="background: linear-gradient(135deg, var(--eco-green), var(--eco-blue)); color: white;">‚úì</div>
            Revisi√≥n y Env√≠o
          </div>
          <div class="section-description">
            Revisa toda la informaci√≥n antes de enviar tu solicitud.
          </div>

          <div id="reviewContent">
            <!-- Dynamically populated -->
          </div>

          <div class="info-box" style="margin-top: 24px;">
            <span class="info-box-icon">‚ÑπÔ∏è</span>
            <div class="info-box-content">
              <strong>¬øQu√© pasa despu√©s de enviar?</strong><br>
              1. Tu supervisor recibir√° un email para aprobar<br>
              2. Administration Manager revisar√° la documentaci√≥n<br>
              3. Finance verificar√° el presupuesto<br>
              4. Recibir√°s un PO number cuando sea aprobado
            </div>
          </div>
        </div>
      </div>

      <!-- Success Screen -->
      <div class="form-section" id="successSection" style="display: none;">
        <div class="form-card">
          <div class="success-screen">
            <div class="success-icon">üéâ</div>
            <h2 class="success-title">¬°Solicitud Enviada!</h2>
            <p class="success-message">
              Tu Purchase Request ha sido enviada exitosamente.<br>
              Recibir√°s un email de confirmaci√≥n en breve.
            </p>
            <div class="pr-number" id="prNumber">PR-2026-001</div>
            <button type="button" class="btn btn-primary" onclick="location.reload()">
              Nueva Solicitud
            </button>
          </div>
        </div>
      </div>

      <!-- Navigation -->
      <div class="form-nav" id="formNav">
        <button type="button" class="btn btn-secondary" id="prevBtn" onclick="prevStep()" style="display: none;">
          ‚Üê Anterior
        </button>
        <button type="button" class="btn btn-primary" id="nextBtn" onclick="nextStep()">
          Siguiente ‚Üí
        </button>
      </div>
    </form>
  </div>

  <script>
    // Grant lists
    const FEDERAL_GRANTS = [
      'NASA Isla Grant 2',
      'ERI / Resilience Institute',
      'OCEANOS / NASA Federal Award',
      'Puerto Rico Space Grant',
      'National Marine Sanctuary Fund',
      'CAPEX - OGP',
      'Department of Labor (Law 52)'
    ];

    const NON_FEDERAL_GRANTS = [
      'Fundaci√≥n √Ångel Ramos',
      'Corteva',
      'Liberty Foundation',
      'Amgen Foundation',
      'First Bank',
      'Goya Puerto Rico',
      'Universal Insurance',
      'Department of Economic Development',
      'Legislative Donations',
      'Unrestricted Funds'
    ];

    // State
    let currentStep = 1;
    let formData = {};
    let lineItemCounter = 1;
    let quotesData = {};

    // Initialize
    document.addEventListener('DOMContentLoaded', function() {
      // Funding source change
      document.getElementById('fundingSource').addEventListener('change', function() {
        const grantNameGroup = document.getElementById('grantNameGroup');
        const grantNameSelect = document.getElementById('grantName');
        const budgetCategoryGroup = document.getElementById('budgetCategoryGroup');
        const budgetCategorySelect = document.getElementById('budgetCategory');
        
        if (this.value) {
          grantNameGroup.style.display = 'block';
          grantNameSelect.disabled = false;
          
          // Show budget category selector
          budgetCategoryGroup.style.display = 'block';
          budgetCategorySelect.disabled = false;
          
          // Populate grants
          grantNameSelect.innerHTML = '<option value="">Selecciona el grant</option>';
          const grants = this.value === 'Federal' ? FEDERAL_GRANTS : NON_FEDERAL_GRANTS;
          grants.forEach(grant => {
            const option = document.createElement('option');
            option.value = grant;
            option.textContent = grant;
            grantNameSelect.appendChild(option);
          });
        } else {
          grantNameGroup.style.display = 'none';
          grantNameSelect.disabled = true;
          budgetCategoryGroup.style.display = 'none';
          budgetCategorySelect.disabled = true;
        }
        
        calculatePrices();
      });

      // Line item changes
      document.getElementById('lineItemsTable').addEventListener('input', function(e) {
        if (e.target.classList.contains('item-qty') || e.target.classList.contains('item-price')) {
          calculatePrices();
        }
      });

      // Tax type change
      document.querySelectorAll('input[name="taxType"]').forEach(radio => {
        radio.addEventListener('change', calculatePrices);
      });

      // Purchase type change
      document.getElementById('purchaseType').addEventListener('change', function() {
        document.getElementById('soleSourceSection').style.display = 
          this.value === 'sole-source' ? 'block' : 'none';
        document.getElementById('emergencySection').style.display = 
          this.value === 'emergency' ? 'block' : 'none';
      });

      // Initial calculation
      calculatePrices();
    });

    // LINE ITEMS MANAGEMENT
    function addLineItem() {
      lineItemCounter++;
      const table = document.getElementById('lineItemsTable');
      const newRow = document.createElement('div');
      newRow.className = 'line-item-row';
      newRow.setAttribute('data-item-id', lineItemCounter);
      newRow.innerHTML = `
        <input type="text" class="item-desc" placeholder="Descripci√≥n del producto/servicio" required>
        <input type="number" class="item-qty" min="1" value="1" required>
        <input type="number" class="item-price" step="0.01" min="0" placeholder="0.00" required>
        <div class="item-subtotal">$0.00</div>
        <button type="button" class="item-remove" onclick="removeLineItem(${lineItemCounter})" title="Eliminar">√ó</button>
      `;
      table.appendChild(newRow);
      calculatePrices();
    }

    function removeLineItem(id) {
      const rows = document.querySelectorAll('.line-item-row[data-item-id]');
      if (rows.length <= 2) { // Keep at least 1 item (plus header)
        alert('Debes tener al menos un item en la compra');
        return;
      }
      const row = document.querySelector(`[data-item-id="${id}"]`);
      if (row) {
        row.remove();
        calculatePrices();
      }
    }

    function getLineItems() {
      const items = [];
      const rows = document.querySelectorAll('.line-item-row[data-item-id]');
      
      rows.forEach(row => {
        const desc = row.querySelector('.item-desc').value;
        const qty = parseFloat(row.querySelector('.item-qty').value) || 0;
        const price = parseFloat(row.querySelector('.item-price').value) || 0;
        
        if (desc && qty > 0 && price >= 0) {
          items.push({
            description: desc,
            quantity: qty,
            unitPrice: price,
            subtotal: qty * price
          });
        }
      });
      
      return items;
    }

    // PRICE CALCULATION
    function calculatePrices() {
      const items = getLineItems();
      let subtotal = 0;
      
      // Calculate subtotal
      items.forEach(item => {
        subtotal += item.subtotal;
      });
      
      // Update individual line item subtotals
      const rows = document.querySelectorAll('.line-item-row[data-item-id]');
      rows.forEach((row, index) => {
        if (items[index]) {
          row.querySelector('.item-subtotal').textContent = '$' + items[index].subtotal.toFixed(2);
        }
      });
      
      // Calculate tax
      const taxType = document.querySelector('input[name="taxType"]:checked').value;
      let tax = 0;
      
      if (taxType === 'ivu') {
        tax = subtotal * 0.115; // 11.5% IVU in Puerto Rico
      }
      
      const total = subtotal + tax;
      
      // Update display
      document.getElementById('displaySubtotal').textContent = '$' + subtotal.toFixed(2);
      document.getElementById('displayTax').textContent = '$' + tax.toFixed(2);
      document.getElementById('displayTotal').textContent = '$' + total.toFixed(2);
      
      // Show/hide tax row
      document.getElementById('taxRow').style.display = taxType === 'ivu' ? 'flex' : 'none';
      
      // Update procurement info
      updateProcurementInfo(total);
      
      return { subtotal, tax, total, items };
    }

    function updateProcurementInfo(total) {
      const fundingSource = document.getElementById('fundingSource').value;
      const infoDiv = document.getElementById('procurementInfo');
      
      if (!fundingSource || total === 0) {
        infoDiv.style.display = 'none';
        return;
      }

      let method, quotes, approval, notes, color;

      if (fundingSource === 'Federal') {
        if (total <= 10000) {
          method = 'Micro-Purchase';
          quotes = 'No se requieren cotizaciones';
          approval = 'Finance Director';
          notes = 'SAM.gov check requerido';
          color = 'var(--eco-green)';
        } else if (total <= 249999) {
          method = 'Small Purchase';
          quotes = 'M√≠nimo 3 cotizaciones requeridas';
          approval = 'Executive Director';
          notes = 'SAM.gov check requerido';
          color = 'var(--eco-yellow)';
        } else {
          method = 'Sealed Bid / Competitive Proposal';
          quotes = 'RFP formal requerido';
          approval = 'Executive Director + Board notification';
          notes = 'Independent Cost Estimate (ICE) requerido ANTES de solicitar cotizaciones';
          color = 'var(--eco-pink)';
        }
      } else {
        if (total <= 500) {
          method = 'Petty Cash';
          quotes = 'No se requieren cotizaciones';
          approval = 'Supervisor (email)';
          notes = 'Ver procedimiento de Petty Cash';
          color = 'var(--eco-green)';
        } else if (total <= 10000) {
          method = 'Purchase Request';
          quotes = '2+ cotizaciones recomendadas';
          approval = 'Finance Director';
          notes = '';
          color = 'var(--eco-teal)';
        } else {
          method = 'Same as Federal';
          quotes = 'M√≠nimo 3 cotizaciones requeridas';
          approval = 'Executive Director';
          notes = '';
          color = 'var(--eco-yellow)';
        }
      }

      infoDiv.innerHTML = `
        <div class="info-box" style="border-left-color: ${color};">
          <span class="info-box-icon">üìã</span>
          <div class="info-box-content">
            <strong>M√©todo de Procurement: ${method}</strong><br>
            <strong>Cotizaciones:</strong> ${quotes}<br>
            <strong>Aprobaci√≥n requerida:</strong> ${approval}
            ${notes ? `<br><strong>Nota:</strong> ${notes}` : ''}
          </div>
        </div>
      `;
      infoDiv.style.display = 'block';

      // Update quotes section in step 3
      updateQuotesSection(quotes, fundingSource);
    }

    // QUOTES SECTION
    function updateQuotesSection(quotesRequired, fundingSource) {
      const quotesSection = document.getElementById('quotesSection');
      const numQuotes = quotesRequired.includes('3') ? 3 : quotesRequired.includes('2') ? 2 : 0;

      if (numQuotes === 0) {
        quotesSection.innerHTML = `
          <div class="alert alert-success">
            <span>‚úì</span>
            <div>No se requieren cotizaciones para este monto.</div>
          </div>
        `;
        return;
      }

      let html = `
        <div class="alert alert-info">
          <span>üìé</span>
          <div>
            Esta compra requiere <strong>${numQuotes} cotizaciones${fundingSource === 'Federal' ? ' (OBLIGATORIO para fondos federales)' : ''}</strong>. 
            Sube los documentos a continuaci√≥n.
          </div>
        </div>
        <div class="quotes-container">
      `;

      for (let i = 1; i <= numQuotes; i++) {
        html += `
          <div class="quote-card" id="quoteCard${i}">
            <div class="quote-header">
              <span class="quote-number">Cotizaci√≥n ${i}${i === 1 ? ' (Principal)' : ''}</span>
              ${i === 1 ? '<span class="quote-badge">PRINCIPAL</span>' : ''}
            </div>
            <div class="quote-fields">
              <div class="form-group">
                <label>Nombre del Vendor <span class="required">*</span></label>
                <input type="text" id="quote${i}Vendor" required placeholder="Ej: Office Depot">
              </div>
              <div class="form-group">
                <label>Monto Total de esta Cotizaci√≥n <span class="required">*</span></label>
                <input type="number" id="quote${i}Amount" step="0.01" min="0" required placeholder="0.00">
              </div>
              <div class="form-group">
                <label>Documento de Cotizaci√≥n <span class="required">*</span></label>
                <div class="file-upload" onclick="document.getElementById('quote${i}File').click()">
                  <div class="file-upload-icon">üìÑ</div>
                  <div class="file-upload-text">Click para subir archivo</div>
                  <div class="file-upload-hint">PDF, JPG, PNG (max 10MB)</div>
                  <input type="file" id="quote${i}File" accept=".pdf,.jpg,.jpeg,.png" onchange="handleQuoteFileSelect(${i}, this)">
                </div>
                <div id="quoteFile${i}List" class="file-list"></div>
              </div>
            </div>
          </div>
        `;
      }

      if (numQuotes > 1) {
        html += `
          </div>
          <div class="form-group" style="margin-top: 24px;">
            <label>Vendor Seleccionado <span class="required">*</span></label>
            <select id="selectedVendor" required>
              <option value="">Selecciona el vendor que elegiste</option>
              <option value="1">Cotizaci√≥n 1 (Principal)</option>
              ${numQuotes >= 2 ? '<option value="2">Cotizaci√≥n 2</option>' : ''}
              ${numQuotes >= 3 ? '<option value="3">Cotizaci√≥n 3</option>' : ''}
            </select>
          </div>
          <div class="form-group">
            <label>Raz√≥n de Selecci√≥n <span class="required">*</span></label>
            <select id="selectionReason" required>
              <option value="">¬øPor qu√© elegiste este vendor?</option>
              <option value="lowest-price">Precio m√°s bajo</option>
              <option value="best-quality">Mejor calidad</option>
              <option value="fastest-delivery">Entrega m√°s r√°pida</option>
              <option value="best-terms">Mejores t√©rminos de pago</option>
              <option value="past-performance">Mejor historial de desempe√±o</option>
              <option value="other">Otra raz√≥n (especificar en justificaci√≥n)</option>
            </select>
          </div>
        `;
      } else {
        html += '</div>';
      }

      quotesSection.innerHTML = html;
    }

    function handleQuoteFileSelect(quoteNum, input) {
      const fileList = document.getElementById(`quoteFile${quoteNum}List`);
      if (input.files.length > 0) {
        const file = input.files[0];
        fileList.innerHTML = `
          <div class="file-item">
            <span class="file-item-name">üìÑ ${file.name}</span>
            <span class="file-item-remove" onclick="clearQuoteFile(${quoteNum})">‚úï</span>
          </div>
        `;
      }
    }

    function clearQuoteFile(quoteNum) {
      document.getElementById(`quote${quoteNum}File`).value = '';
      document.getElementById(`quoteFile${quoteNum}List`).innerHTML = '';
    }

    // NAVIGATION
    function nextStep() {
      if (!validateStep(currentStep)) {
        return;
      }

      saveStepData(currentStep);

      if (currentStep < 4) {
        currentStep++;
        updateSteps();
        if (currentStep === 4) {
          populateReview();
        }
      } else {
        submitForm();
      }
    }

    function prevStep() {
      if (currentStep > 1) {
        currentStep--;
        updateSteps();
      }
    }

    function updateSteps() {
      document.querySelectorAll('.form-section').forEach((section, index) => {
        section.classList.toggle('active', index + 1 === currentStep);
      });

      document.querySelectorAll('.step').forEach((step, index) => {
        if (index + 1 < currentStep) {
          step.classList.add('completed');
          step.classList.remove('active');
        } else if (index + 1 === currentStep) {
          step.classList.add('active');
          step.classList.remove('completed');
        } else {
          step.classList.remove('active', 'completed');
        }
      });

      const progress = ((currentStep - 1) / 3) * 100;
      document.getElementById('progressFill').style.width = progress + '%';

      document.getElementById('prevBtn').style.display = currentStep > 1 ? 'block' : 'none';
      document.getElementById('nextBtn').textContent = currentStep === 4 ? '‚úì Enviar Solicitud' : 'Siguiente ‚Üí';

      window.scrollTo(0, 0);
    }

    function validateStep(step) {
      switch(step) {
        case 1:
          const requiredFields1 = ['requestorName', 'requestorEmail', 'department', 'supervisorName', 'fundingSource', 'grantName', 'budgetCategory'];
          for (const fieldId of requiredFields1) {
            const field = document.getElementById(fieldId);
            if (!field || !field.value.trim()) {
              alert('Por favor completa todos los campos requeridos');
              field?.focus();
              return false;
            }
          }
          break;
          
        case 2:
          const vendor = document.getElementById('vendorName').value;
          const desc = document.getElementById('generalDescription').value;
          
          if (!vendor.trim() || !desc.trim()) {
            alert('Por favor completa el vendor y la descripci√≥n general');
            return false;
          }
          
          const items = getLineItems();
          if (items.length === 0) {
            alert('Debes agregar al menos un item a la compra');
            return false;
          }
          
          const prices = calculatePrices();
          if (prices.total === 0) {
            alert('El total de la compra no puede ser $0');
            return false;
          }
          break;
          
        case 3:
          const purchaseType = document.getElementById('purchaseType').value;
          
          if (purchaseType === 'sole-source') {
            const justification = document.getElementById('soleSourceJustification').value;
            if (!justification.trim()) {
              alert('Por favor ingresa la justificaci√≥n de Sole Source');
              return false;
            }
          }
          
          if (purchaseType === 'emergency') {
            const justification = document.getElementById('emergencyJustification').value;
            if (!justification.trim()) {
              alert('Por favor ingresa la justificaci√≥n de emergencia');
              return false;
            }
            const prices = calculatePrices();
            const fundingSource = document.getElementById('fundingSource').value;
            if (prices.total > 500 || fundingSource === 'Federal') {
              alert('Compras de emergencia deben ser ‚â§$500 y non-federal');
              return false;
            }
          }
          
          // Validate quotes if required
          const quotesSection = document.getElementById('quotesSection');
          if (quotesSection.innerHTML.includes('Cotizaci√≥n 1')) {
            const quote1Vendor = document.getElementById('quote1Vendor');
            const quote1Amount = document.getElementById('quote1Amount');
            const quote1File = document.getElementById('quote1File');
            
            if (!quote1Vendor || !quote1Vendor.value.trim()) {
              alert('Por favor completa la informaci√≥n de la Cotizaci√≥n 1');
              return false;
            }
            if (!quote1Amount || !quote1Amount.value) {
              alert('Por favor ingresa el monto de la Cotizaci√≥n 1');
              return false;
            }
            if (!quote1File || !quote1File.files.length) {
              alert('Por favor sube el documento de la Cotizaci√≥n 1');
              return false;
            }
            
            // Check if multiple quotes required
            if (document.getElementById('quote2Vendor')) {
              const quote2Vendor = document.getElementById('quote2Vendor');
              const quote2Amount = document.getElementById('quote2Amount');
              const quote2File = document.getElementById('quote2File');
              
              if (!quote2Vendor.value.trim() || !quote2Amount.value || !quote2File.files.length) {
                alert('Esta compra requiere m√≠nimo 2-3 cotizaciones. Por favor completa todas.');
                return false;
              }
              
              if (document.getElementById('quote3Vendor')) {
                const quote3Vendor = document.getElementById('quote3Vendor');
                const quote3Amount = document.getElementById('quote3Amount');
                const quote3File = document.getElementById('quote3File');
                
                if (!quote3Vendor.value.trim() || !quote3Amount.value || !quote3File.files.length) {
                  alert('Esta compra requiere 3 cotizaciones. Por favor completa todas.');
                  return false;
                }
              }
              
              // Validate selection
              const selectedVendor = document.getElementById('selectedVendor');
              const selectionReason = document.getElementById('selectionReason');
              
              if (!selectedVendor || !selectedVendor.value) {
                alert('Por favor selecciona qu√© vendor elegiste');
                return false;
              }
              if (!selectionReason || !selectionReason.value) {
                alert('Por favor explica por qu√© elegiste ese vendor');
                return false;
              }
            }
          }
          break;
      }

      return true;
    }

    function saveStepData(step) {
      switch(step) {
        case 1:
          formData.requestorName = document.getElementById('requestorName').value;
          formData.requestorEmail = document.getElementById('requestorEmail').value;
          formData.department = document.getElementById('department').value;
          formData.position = document.getElementById('position').value;
          formData.supervisorName = document.getElementById('supervisorName').value;
          formData.fundingSource = document.getElementById('fundingSource').value;
          formData.grantName = document.getElementById('grantName').value;
          formData.budgetCategory = document.getElementById('budgetCategory').value;
          break;
          
        case 2:
          formData.vendorName = document.getElementById('vendorName').value;
          formData.generalDescription = document.getElementById('generalDescription').value;
          
          const prices = calculatePrices();
          formData.lineItems = prices.items;
          formData.subtotal = prices.subtotal;
          formData.taxType = document.querySelector('input[name="taxType"]:checked').value;
          formData.taxAmount = prices.tax;
          formData.totalAmount = prices.total;
          break;
          
        case 3:
          formData.purchaseType = document.getElementById('purchaseType').value;
          
          if (formData.purchaseType === 'sole-source') {
            formData.soleSourceJustification = document.getElementById('soleSourceJustification').value;
          }
          if (formData.purchaseType === 'emergency') {
            formData.emergencyJustification = document.getElementById('emergencyJustification').value;
          }
          
          // Save quotes
          formData.quotes = [];
          for (let i = 1; i <= 3; i++) {
            const vendorEl = document.getElementById(`quote${i}Vendor`);
            if (vendorEl && vendorEl.value) {
              formData.quotes.push({
                vendor: vendorEl.value,
                amount: document.getElementById(`quote${i}Amount`).value,
                fileUrl: `quote${i}_file` // In production, upload to Google Drive
              });
            }
          }
          
          const selectedVendorEl = document.getElementById('selectedVendor');
          if (selectedVendorEl && selectedVendorEl.value) {
            formData.selectedQuoteIndex = parseInt(selectedVendorEl.value) - 1;
            formData.selectionReason = document.getElementById('selectionReason').value;
          }
          break;
      }
    }

    function populateReview() {
      const content = document.getElementById('reviewContent');
      
      const taxTypeText = {
        'ivu': 'IVU (11.5%) incluido',
        'exempt': 'Tax Exempt',
        'none': 'No aplica IVU'
      };

      const method = calculateProcurementMethod(formData.totalAmount, formData.fundingSource);

      let lineItemsHTML = '<table style="width: 100%; border-collapse: collapse; margin: 12px 0;">';
      lineItemsHTML += '<tr style="background: var(--slate); font-weight: 600;"><th style="padding: 8px; text-align: left;">Item</th><th style="padding: 8px; text-align: center;">Cant.</th><th style="padding: 8px; text-align: right;">Precio</th><th style="padding: 8px; text-align: right;">Subtotal</th></tr>';
      
      formData.lineItems.forEach(item => {
        lineItemsHTML += `
          <tr style="border-bottom: 1px solid var(--border);">
            <td style="padding: 8px;">${item.description}</td>
            <td style="padding: 8px; text-align: center;">${item.quantity}</td>
            <td style="padding: 8px; text-align: right;">$${item.unitPrice.toFixed(2)}</td>
            <td style="padding: 8px; text-align: right; font-weight: 600;">$${item.subtotal.toFixed(2)}</td>
          </tr>
        `;
      });
      lineItemsHTML += '</table>';

      let quotesHTML = '';
      if (formData.quotes && formData.quotes.length > 0) {
        quotesHTML = '<div style="margin-top: 16px;"><strong>Cotizaciones:</strong><ul>';
        formData.quotes.forEach((quote, index) => {
          const isSelected = index === formData.selectedQuoteIndex;
          quotesHTML += `<li style="${isSelected ? 'color: var(--eco-purple); font-weight: 700;' : ''}">${quote.vendor} - $${parseFloat(quote.amount).toFixed(2)} ${isSelected ? '‚úì SELECCIONADO' : ''}</li>`;
        });
        quotesHTML += '</ul>';
        if (formData.selectionReason) {
          const reasons = {
            'lowest-price': 'Precio m√°s bajo',
            'best-quality': 'Mejor calidad',
            'fastest-delivery': 'Entrega m√°s r√°pida',
            'best-terms': 'Mejores t√©rminos',
            'past-performance': 'Mejor historial',
            'other': 'Otra raz√≥n'
          };
          quotesHTML += `<div style="margin-top: 8px;"><strong>Raz√≥n:</strong> ${reasons[formData.selectionReason] || formData.selectionReason}</div>`;
        }
        quotesHTML += '</div>';
      }

      content.innerHTML = `
        <div style="display: grid; gap: 24px;">
          <div style="background: var(--slate); padding: 20px; border-radius: 12px;">
            <h3 style="font-size: 14px; font-weight: 700; color: var(--muted); margin-bottom: 16px; text-transform: uppercase; letter-spacing: 0.05em;">Solicitante</h3>
            <div style="display: grid; gap: 12px;">
              <div><strong>Nombre:</strong> ${formData.requestorName}</div>
              <div><strong>Email:</strong> ${formData.requestorEmail}</div>
              <div><strong>Departamento:</strong> ${formData.department}</div>
              <div><strong>Supervisor:</strong> ${formData.supervisorName}</div>
            </div>
          </div>

          <div style="background: var(--slate); padding: 20px; border-radius: 12px;">
            <h3 style="font-size: 14px; font-weight: 700; color: var(--muted); margin-bottom: 16px; text-transform: uppercase; letter-spacing: 0.05em;">Detalles de Compra</h3>
            <div style="display: grid; gap: 12px;">
              <div><strong>Vendor:</strong> ${formData.vendorName}</div>
              <div><strong>Fuente:</strong> ${formData.fundingSource}</div>
              <div><strong>Grant:</strong> ${formData.grantName}</div>
              <div><strong>Categor√≠a de Presupuesto:</strong> ${formData.budgetCategory}</div>
              <div><strong>Descripci√≥n:</strong> ${formData.generalDescription}</div>
            </div>
            
            <h4 style="margin-top: 16px; margin-bottom: 8px; font-weight: 700;">Items:</h4>
            ${lineItemsHTML}
            
            <div style="margin-top: 12px; padding-top: 12px; border-top: 2px solid var(--border);">
              <div style="display: flex; justify-content: space-between; margin-bottom: 4px;">
                <span>Subtotal:</span>
                <strong>$${formData.subtotal.toFixed(2)}</strong>
              </div>
              ${formData.taxAmount > 0 ? `
                <div style="display: flex; justify-content: space-between; margin-bottom: 4px; color: var(--muted);">
                  <span>${taxTypeText[formData.taxType]}:</span>
                  <span>$${formData.taxAmount.toFixed(2)}</span>
                </div>
              ` : `
                <div style="color: var(--muted); font-size: 13px;">${taxTypeText[formData.taxType]}</div>
              `}
              <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: 800; color: var(--eco-purple); margin-top: 8px; padding-top: 8px; border-top: 2px solid var(--eco-purple);">
                <span>TOTAL:</span>
                <span>$${formData.totalAmount.toFixed(2)}</span>
              </div>
            </div>
            
            ${quotesHTML}
          </div>

          <div style="background: linear-gradient(135deg, rgba(107, 70, 193, 0.05), rgba(14, 116, 144, 0.05)); padding: 20px; border-radius: 12px; border: 2px solid var(--eco-purple);">
            <h3 style="font-size: 14px; font-weight: 700; color: var(--eco-purple); margin-bottom: 16px; text-transform: uppercase; letter-spacing: 0.05em;">Proceso de Aprobaci√≥n</h3>
            <div style="display: grid; gap: 12px;">
              <div><strong>M√©todo:</strong> ${method.method}</div>
              <div><strong>Aprobaci√≥n requerida:</strong> ${method.approval}</div>
              ${formData.purchaseType !== 'standard' ? `<div><strong>Tipo:</strong> ${formData.purchaseType === 'sole-source' ? 'Sole Source' : 'Emergencia'}</div>` : ''}
            </div>
          </div>
        </div>
      `;
    }

    function calculateProcurementMethod(amount, fundingSource) {
      let method, approval;
      
      if (fundingSource === 'Federal') {
        if (amount <= 10000) {
          method = 'Micro-Purchase';
          approval = 'Finance Director';
        } else if (amount <= 249999) {
          method = 'Small Purchase';
          approval = 'Executive Director';
        } else {
          method = 'Sealed Bid';
          approval = 'Executive Director + Board';
        }
      } else {
        if (amount <= 500) {
          method = 'Petty Cash';
          approval = 'Supervisor';
        } else if (amount <= 10000) {
          method = 'Purchase Request';
          approval = 'Finance Director';
        } else {
          method = 'Same as Federal';
          approval = 'Executive Director';
        }
      }
      
      return { method, approval };
    }

    async function submitForm() {
      const nextBtn = document.getElementById('nextBtn');
      const originalText = nextBtn.innerHTML;
      nextBtn.innerHTML = '<div class="spinner"></div>';
      nextBtn.disabled = true;

      try {
        // Prepare data
        const submitData = {
          action: 'submitPR',
          ...formData
        };
        
        console.log('Sending data to Apps Script:', submitData);

        // Send to Google Apps Script
        const response = await fetch('https://script.google.com/macros/s/AKfycbzVsk2ymFw1kXKabjHvSN11N_GbgBXROIHtT2F0rNRj7VCvfsQeZ01c0VFNxJoIpBpDyA/exec', {
          method: 'POST',
          headers: {
            'Content-Type': 'text/plain',
          },
          body: JSON.stringify(submitData)
        });

        console.log('Response received from Apps Script');

        // Show success screen
        document.querySelectorAll('.form-section').forEach(s => s.style.display = 'none');
        document.getElementById('formNav').style.display = 'none';
        document.getElementById('successSection').style.display = 'block';

        // Generate PR number (temporary - will be replaced by real one from backend)
        const year = new Date().getFullYear();
        const randomNum = Math.floor(Math.random() * 900) + 100;
        const prNumber = `PR-${year}-${randomNum}`;
        document.getElementById('prNumber').textContent = prNumber;

        console.log('Form Data v1.3 submitted:', formData);
        
      } catch (error) {
        console.error('Submit error:', error);
        alert('Error al enviar la solicitud. Por favor intenta de nuevo.\n\nDetalles: ' + error.message);
        nextBtn.innerHTML = originalText;
        nextBtn.disabled = false;
      }
    }
  </script>
</body>
</html>
